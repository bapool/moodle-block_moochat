/**
 * MooChat JavaScript module
 * @package
 * @copyright  2025 Brian A. Pool
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_moochat/chat",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){return{init:function(moochatid){var conversationHistory=[],strings=[];Str.get_strings([{key:"conversationsremaining_js",component:"mod_moochat"},{key:"messagesremaining_js",component:"mod_moochat"},{key:"thinking_js",component:"mod_moochat"},{key:"ratelimitreached_title",component:"mod_moochat"},{key:"error_title",component:"mod_moochat"},{key:"maxmessagesreached_title",component:"mod_moochat"},{key:"connectionerror",component:"mod_moochat"},{key:"chatcleared",component:"mod_moochat"},{key:"confirmclear",component:"mod_moochat"}]).done((function(s){strings=s}));var messagesDiv=$("#moochat-messages-"+moochatid),inputField=$("#moochat-input-"+moochatid),sendButton=$("#moochat-send-"+moochatid),clearButton=$("#moochat-clear-"+moochatid),remainingDiv=$("#moochat-remaining-"+moochatid),updateRemaining=function(conversationsRemaining,messagesRemaining){var html="";conversationsRemaining>=0&&(html+='<div class="alert alert-info">'+strings[0]+": "+conversationsRemaining+"</div>"),messagesRemaining>=0&&(html+='<div class="alert alert-info">'+strings[1]+": "+messagesRemaining+"</div>"),""!==html?(remainingDiv.html(html),remainingDiv.show()):remainingDiv.hide()},sendMessage=function(){var message=inputField.val().trim();if(""!==message){inputField.prop("disabled",!0),sendButton.prop("disabled",!0),addMessage("user",message),conversationHistory.push({role:"user",content:message}),inputField.val("");var thinkingId="thinking-"+Date.now();messagesDiv.append('<div class="moochat-message moochat-assistant" id="'+thinkingId+'"><em>'+strings[2]+"</em></div>"),scrollToBottom(),Ajax.call([{methodname:"mod_moochat_send_message",args:{moochatid:moochatid,message:message,history:JSON.stringify(conversationHistory)}}])[0].then((function(response){if($("#"+thinkingId).remove(),response.error||!response.success)void 0!==response.conversationsremaining&&0===response.conversationsremaining?(Notification.alert(strings[3],response.error,"OK"),inputField.prop("disabled",!0),sendButton.prop("disabled",!0),updateRemaining(0,response.messagesremaining||-1)):"maxmessagesreached"===response.errorcode?(Notification.alert(strings[5],response.error,"OK"),updateRemaining(response.conversationsremaining||-1,0)):Notification.alert(strings[4],response.error,"OK");else if(response.success&&response.reply){addMessage("assistant",response.reply),conversationHistory.push({role:"assistant",content:response.reply});var convRemaining=void 0!==response.conversationsremaining?response.conversationsremaining:-1,msgRemaining=void 0!==response.messagesremaining?response.messagesremaining:-1;updateRemaining(convRemaining,msgRemaining),0===msgRemaining&&(inputField.prop("disabled",!0),sendButton.prop("disabled",!0))}var shouldEnable=!0;return 0!==response.conversationsremaining&&0!==response.messagesremaining||(shouldEnable=!1),shouldEnable&&(inputField.prop("disabled",!1),sendButton.prop("disabled",!1),inputField.focus()),!0})).catch((function(){$("#"+thinkingId).remove(),Notification.alert(strings[4],strings[6],"OK"),inputField.prop("disabled",!1),sendButton.prop("disabled",!1)}))}},addMessage=function(role,content){var messageHtml='<div class="moochat-message '+("user"===role?"moochat-user":"moochat-assistant")+'">'+formatMessage(content)+"</div>";messagesDiv.append(messageHtml),scrollToBottom()},formatMessage=function(text){var escaped=escapeHtml(text),sentenceCount=(text.match(/[.!?]+/g)||[]).length;return text.length<100&&sentenceCount<=3?escaped:escaped=(escaped=(escaped=(escaped="<p>"+(escaped=(escaped=(escaped=(escaped=(escaped=escaped.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/__([^_]+)__/g,"<strong>$1</strong>")).replace(/\*([^*\n]+)\*/g,"<em>$1</em>")).replace(/\n\n+/g,"</p><p>")).replace(/\n/g,"<br>"))+"</p>").replace(/(\d+)\.\s/g,"<br><strong>$1.</strong> ")).replace(/<br>[-*]\s+/g,"<br>• ")).replace(/<p>[-*]\s+/g,"<p>• ")},scrollToBottom=function(){messagesDiv.scrollTop(messagesDiv[0].scrollHeight)},escapeHtml=function(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML};sendButton.on("click",sendMessage),inputField.on("keypress",(function(e){13!==e.which||e.shiftKey||(e.preventDefault(),sendMessage())})),clearButton.on("click",(function(){confirm(strings[8])&&(conversationHistory=[],messagesDiv.html('<p class="moochat-welcome">'+strings[7]+"</p>"),inputField.val("").focus())})),inputField.focus()}}}));

//# sourceMappingURL=chat.min.js.map