{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * MooChat JavaScript module\n * @package\n * @copyright  2025 Brian A. Pool\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    return {\n        init: function(moochatid) {\n\n            var conversationHistory = [];\n            // Var remainingQuestions = -1; // -1 means unlimited\n\n            // Load language strings\n            var strings = [];\n            Str.get_strings([\n                {key: 'conversationsremaining_js', component: 'mod_moochat'},\n                {key: 'messagesremaining_js', component: 'mod_moochat'},\n                {key: 'thinking_js', component: 'mod_moochat'},\n                {key: 'ratelimitreached_title', component: 'mod_moochat'},\n                {key: 'error_title', component: 'mod_moochat'},\n                {key: 'maxmessagesreached_title', component: 'mod_moochat'},\n                {key: 'connectionerror', component: 'mod_moochat'},\n                {key: 'chatcleared', component: 'mod_moochat'},\n                {key: 'confirmclear', component: 'mod_moochat'}\n            ]).done(function(s) {\n                strings = s;\n            });\n\n            var messagesDiv = $('#moochat-messages-' + moochatid);\n            var inputField = $('#moochat-input-' + moochatid);\n            var sendButton = $('#moochat-send-' + moochatid);\n            var clearButton = $('#moochat-clear-' + moochatid);\n            var remainingDiv = $('#moochat-remaining-' + moochatid);\n\n            // Update remaining counters display\n            var updateRemaining = function(conversationsRemaining, messagesRemaining) {\n                var html = '';\n\n                if (conversationsRemaining >= 0) {\n                    html += '<div class=\"alert alert-info\">' + strings[0] + ': ' + conversationsRemaining + '</div>';\n                }\n\n                if (messagesRemaining >= 0) {\n                    html += '<div class=\"alert alert-info\">' + strings[1] + ': ' + messagesRemaining + '</div>';\n                }\n\n                if (html !== '') {\n                    remainingDiv.html(html);\n                    remainingDiv.show();\n                } else {\n                    remainingDiv.hide();\n                }\n            };\n\n            // Send message\n            var sendMessage = function() {\n                var message = inputField.val().trim();\n\n                if (message === '') {\n                    return;\n                }\n\n                // Disable input while processing\n                inputField.prop('disabled', true);\n                sendButton.prop('disabled', true);\n\n                // Add user message to display\n                addMessage('user', message);\n\n                // Add to history\n                conversationHistory.push({\n                    role: 'user',\n                    content: message\n                });\n\n                // Clear input\n                inputField.val('');\n\n                // Show thinking indicator\n                var thinkingId = 'thinking-' + Date.now();\n                messagesDiv.append(\n                    '<div class=\"moochat-message moochat-assistant\" id=\"' + thinkingId + '\">' +\n                    '<em>' + strings[2] + '</em></div>'\n                );\n                scrollToBottom();\n\n                // Call API using Moodle's Ajax module\n                Ajax.call([{\n                    methodname: 'mod_moochat_send_message',\n                    args: {\n                        moochatid: moochatid,\n                        message: message,\n                        history: JSON.stringify(conversationHistory)\n                    }\n                }])[0].then(function(response) {\n                    // Remove thinking indicator\n                    $('#' + thinkingId).remove();\n\n                    if (response.error || !response.success) {\n                        // Check if this is a rate limit error (conversations)\n                        if (response.conversationsremaining !== undefined && response.conversationsremaining === 0) {\n                            Notification.alert(strings[3], response.error, 'OK');\n                            inputField.prop('disabled', true);\n                            sendButton.prop('disabled', true);\n                            updateRemaining(0, response.messagesremaining || -1);\n                        } else if (response.errorcode === 'maxmessagesreached') {\n                            // Max messages per session error\n                            Notification.alert(strings[5], response.error, 'OK');\n                            updateRemaining(response.conversationsremaining || -1, 0);\n                        } else {\n                            // Generic error\n                            Notification.alert(strings[4], response.error, 'OK');\n                        }\n\n                    } else if (response.success && response.reply) {\n                        // Add assistant reply\n                        addMessage('assistant', response.reply);\n\n                        // Add to history\n                        conversationHistory.push({\n                            role: 'assistant',\n                            content: response.reply\n                        });\n\n                        // Update remaining counters\n                        var convRemaining = response.conversationsremaining !== undefined ?\n                            response.conversationsremaining : -1;\n                        var msgRemaining = response.messagesremaining !== undefined ?\n                            response.messagesremaining : -1;\n\n                        updateRemaining(convRemaining, msgRemaining);\n\n                        // Disable if no messages left in this conversation\n                        if (msgRemaining === 0) {\n                            inputField.prop('disabled', true);\n                            sendButton.prop('disabled', true);\n                        }\n                    }\n\n                    // Re-enable input (unless disabled by limits)\n                    var shouldEnable = true;\n                    if (response.conversationsremaining === 0 || response.messagesremaining === 0) {\n                        shouldEnable = false;\n                    }\n                    if (shouldEnable) {\n                        inputField.prop('disabled', false);\n                        sendButton.prop('disabled', false);\n                        inputField.focus();\n                    }\n\n                    return true;\n               }).catch(function() {\n                    $('#' + thinkingId).remove();\n                    Notification.alert(strings[4], strings[6], 'OK');\n                    inputField.prop('disabled', false);\n                    sendButton.prop('disabled', false);\n                });\n            };\n\n            // Add message to display\n            var addMessage = function(role, content) {\n                var messageClass = role === 'user' ? 'moochat-user' : 'moochat-assistant';\n                var formattedContent = formatMessage(content);\n                var messageHtml = '<div class=\"moochat-message ' + messageClass + '\">' +\n                                 formattedContent + '</div>';\n                messagesDiv.append(messageHtml);\n                scrollToBottom();\n            };\n\n            // Format message content with line breaks and basic formatting\n            var formatMessage = function(text) {\n                // Escape HTML first\n                var escaped = escapeHtml(text);\n\n                // Only format if it's a longer response (more than 100 chars or has multiple sentences)\n                var sentenceCount = (text.match(/[.!?]+/g) || []).length;\n\n                if (text.length < 100 && sentenceCount <= 3) {\n                    // Short response - return as-is\n                    return escaped;\n                }\n\n                // Handle markdown bold (**text** or __text__)\n                escaped = escaped.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\n                escaped = escaped.replace(/__([^_]+)__/g, '<strong>$1</strong>');\n\n                // Handle markdown italic (*text* or _text_) - but not bullet points\n                escaped = escaped.replace(/\\*([^*\\n]+)\\*/g, '<em>$1</em>');\n\n                // Convert double line breaks to paragraphs\n                escaped = escaped.replace(/\\n\\n+/g, '</p><p>');\n\n                // Convert single line breaks to <br>\n                escaped = escaped.replace(/\\n/g, '<br>');\n\n                // Wrap in paragraph tags\n                escaped = '<p>' + escaped + '</p>';\n\n                // Handle numbered lists (1. 2. 3.)\n                escaped = escaped.replace(/(\\d+)\\.\\s/g, '<br><strong>$1.</strong> ');\n\n                // Handle bullet points at start of line (- or * followed by space)\n                escaped = escaped.replace(/<br>[-*]\\s+/g, '<br>• ');\n                escaped = escaped.replace(/<p>[-*]\\s+/g, '<p>• ');\n\n                return escaped;\n            };\n\n            // Scroll to bottom of messages\n            var scrollToBottom = function() {\n                messagesDiv.scrollTop(messagesDiv[0].scrollHeight);\n            };\n\n            // Escape HTML\n            var escapeHtml = function(text) {\n                var div = document.createElement('div');\n                div.textContent = text;\n                return div.innerHTML;\n            };\n\n            // Clear chat (visual only - doesn't reset server counter)\n            var clearChat = function() {\n                conversationHistory = [];\n                messagesDiv.html('<p class=\"moochat-welcome\">' + strings[7] + '</p>');\n                inputField.val('').focus();\n                // Note: remaining questions counter stays the same\n            };\n\n            // Event handlers\n            sendButton.on('click', sendMessage);\n\n            inputField.on('keypress', function(e) {\n                if (e.which === 13 && !e.shiftKey) {\n                    e.preventDefault();\n                    sendMessage();\n                }\n            });\n\n            clearButton.on('click', function() {\n                // eslint-disable-next-line no-alert\n                if (confirm(strings[8])) {\n                    clearChat();\n                }\n            });\n\n            // Focus input on load\n            inputField.focus();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","init","moochatid","conversationHistory","strings","get_strings","key","component","done","s","messagesDiv","inputField","sendButton","clearButton","remainingDiv","updateRemaining","conversationsRemaining","messagesRemaining","html","show","hide","sendMessage","message","val","trim","prop","addMessage","push","role","content","thinkingId","Date","now","append","scrollToBottom","call","methodname","args","history","JSON","stringify","then","response","remove","error","success","undefined","conversationsremaining","alert","messagesremaining","errorcode","reply","convRemaining","msgRemaining","shouldEnable","focus","catch","messageHtml","formatMessage","text","escaped","escapeHtml","sentenceCount","match","length","replace","scrollTop","scrollHeight","div","document","createElement","textContent","innerHTML","on","e","which","shiftKey","preventDefault","confirm"],"mappings":";;;;;;AAeAA,0BAAO,CAAC,SAAU,YAAa,oBAAqB,aAAa,SAASC,EAAGC,KAAMC,aAAcC,WAEtF,CACHC,KAAM,SAASC,eAEPC,oBAAsB,GAItBC,QAAU,GACdJ,IAAIK,YAAY,CACZ,CAACC,IAAK,4BAA6BC,UAAW,eAC9C,CAACD,IAAK,uBAAwBC,UAAW,eACzC,CAACD,IAAK,cAAeC,UAAW,eAChC,CAACD,IAAK,yBAA0BC,UAAW,eAC3C,CAACD,IAAK,cAAeC,UAAW,eAChC,CAACD,IAAK,2BAA4BC,UAAW,eAC7C,CAACD,IAAK,kBAAmBC,UAAW,eACpC,CAACD,IAAK,cAAeC,UAAW,eAChC,CAACD,IAAK,eAAgBC,UAAW,iBAClCC,MAAK,SAASC,GACbL,QAAUK,SAGVC,YAAcb,EAAE,qBAAuBK,WACvCS,WAAad,EAAE,kBAAoBK,WACnCU,WAAaf,EAAE,iBAAmBK,WAClCW,YAAchB,EAAE,kBAAoBK,WACpCY,aAAejB,EAAE,sBAAwBK,WAGzCa,gBAAkB,SAASC,uBAAwBC,uBAC/CC,KAAO,GAEPF,wBAA0B,IAC1BE,MAAQ,iCAAmCd,QAAQ,GAAK,KAAOY,uBAAyB,UAGxFC,mBAAqB,IACrBC,MAAQ,iCAAmCd,QAAQ,GAAK,KAAOa,kBAAoB,UAG1E,KAATC,MACAJ,aAAaI,KAAKA,MAClBJ,aAAaK,QAEbL,aAAaM,QAKjBC,YAAc,eACVC,QAAUX,WAAWY,MAAMC,UAEf,KAAZF,SAKJX,WAAWc,KAAK,YAAY,GAC5Bb,WAAWa,KAAK,YAAY,GAG5BC,WAAW,OAAQJ,SAGnBnB,oBAAoBwB,KAAK,CACrBC,KAAM,OACNC,QAASP,UAIbX,WAAWY,IAAI,QAGXO,WAAa,YAAcC,KAAKC,MACpCtB,YAAYuB,OACR,sDAAwDH,WAAxD,SACS1B,QAAQ,GAAK,eAE1B8B,iBAGApC,KAAKqC,KAAK,CAAC,CACPC,WAAY,2BACZC,KAAM,CACFnC,UAAWA,UACXoB,QAASA,QACTgB,QAASC,KAAKC,UAAUrC,yBAE5B,GAAGsC,MAAK,SAASC,aAEjB7C,EAAE,IAAMiC,YAAYa,SAEhBD,SAASE,QAAUF,SAASG,aAEYC,IAApCJ,SAASK,wBAA4E,IAApCL,SAASK,wBAC1DhD,aAAaiD,MAAM5C,QAAQ,GAAIsC,SAASE,MAAO,MAC/CjC,WAAWc,KAAK,YAAY,GAC5Bb,WAAWa,KAAK,YAAY,GAC5BV,gBAAgB,EAAG2B,SAASO,oBAAsB,IACpB,uBAAvBP,SAASQ,WAEhBnD,aAAaiD,MAAM5C,QAAQ,GAAIsC,SAASE,MAAO,MAC/C7B,gBAAgB2B,SAASK,yBAA2B,EAAG,IAGvDhD,aAAaiD,MAAM5C,QAAQ,GAAIsC,SAASE,MAAO,WAGhD,GAAIF,SAASG,SAAWH,SAASS,MAAO,CAE3CzB,WAAW,YAAagB,SAASS,OAGjChD,oBAAoBwB,KAAK,CACrBC,KAAM,YACNC,QAASa,SAASS,YAIlBC,mBAAoDN,IAApCJ,SAASK,uBACzBL,SAASK,wBAA0B,EACnCM,kBAA8CP,IAA/BJ,SAASO,kBACxBP,SAASO,mBAAqB,EAElClC,gBAAgBqC,cAAeC,cAGV,IAAjBA,eACA1C,WAAWc,KAAK,YAAY,GAC5Bb,WAAWa,KAAK,YAAY,QAKhC6B,cAAe,SACqB,IAApCZ,SAASK,wBAA+D,IAA/BL,SAASO,oBAClDK,cAAe,GAEfA,eACA3C,WAAWc,KAAK,YAAY,GAC5Bb,WAAWa,KAAK,YAAY,GAC5Bd,WAAW4C,UAGR,KACTC,OAAM,WACJ3D,EAAE,IAAMiC,YAAYa,SACpB5C,aAAaiD,MAAM5C,QAAQ,GAAIA,QAAQ,GAAI,MAC3CO,WAAWc,KAAK,YAAY,GAC5Bb,WAAWa,KAAK,YAAY,QAKhCC,WAAa,SAASE,KAAMC,aAGxB4B,YAAc,gCAFU,SAAT7B,KAAkB,eAAiB,qBAEY,KAD3C8B,cAAc7B,SAED,SACpCnB,YAAYuB,OAAOwB,aACnBvB,kBAIAwB,cAAgB,SAASC,UAErBC,QAAUC,WAAWF,MAGrBG,eAAiBH,KAAKI,MAAM,YAAc,IAAIC,cAE9CL,KAAKK,OAAS,KAAOF,eAAiB,EAE/BF,QAwBXA,SADAA,SAHAA,SAHAA,QAAU,OAHVA,SAHAA,SAHAA,SAHAA,SADAA,QAAUA,QAAQK,QAAQ,mBAAoB,wBAC5BA,QAAQ,eAAgB,wBAGxBA,QAAQ,iBAAkB,gBAG1BA,QAAQ,SAAU,YAGlBA,QAAQ,MAAO,SAGL,QAGVA,QAAQ,aAAc,8BAGtBA,QAAQ,eAAgB,WACxBA,QAAQ,cAAe,UAMzC/B,eAAiB,WACjBxB,YAAYwD,UAAUxD,YAAY,GAAGyD,eAIrCN,WAAa,SAASF,UAClBS,IAAMC,SAASC,cAAc,cACjCF,IAAIG,YAAcZ,KACXS,IAAII,WAYf5D,WAAW6D,GAAG,QAASpD,aAEvBV,WAAW8D,GAAG,YAAY,SAASC,GACf,KAAZA,EAAEC,OAAiBD,EAAEE,WACrBF,EAAEG,iBACFxD,kBAIRR,YAAY4D,GAAG,SAAS,WAEhBK,QAAQ1E,QAAQ,MAlBpBD,oBAAsB,GACtBO,YAAYQ,KAAK,8BAAgCd,QAAQ,GAAK,QAC9DO,WAAWY,IAAI,IAAIgC,YAsBvB5C,WAAW4C"}